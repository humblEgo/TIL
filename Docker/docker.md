## Docker

### 도커의 등장

2013년 파이콘에서 dotCloud의 창업자인 Solomon Hykes가 [The future of Linux Containers](https://www.youtube.com/watch?v=wW9CAH9nSLs&feature=youtu.be)라는 세션을 발표하면서 등장했다.
DevOps의 등장으로 개발주기는 짧아지고, 배포는 더 빈번해지며, 마이크로서비스 아키텍쳐가 유행하면서 프로그램은 더 잘게 쪼개어져 관리가 복잡해진 시점에서 도커(Docker)의 등장은 서버관리 방식을 완전히 바꾸기에 충분했다. _(지금 거의 대세)_

> 그래서 도커란? 도커는 컨테이너를 관리하는 플랫폼이다.

도커는 **컨테이너 기반의 오픈소스 가상화 플랫폼**이다.

#### 컨테이너

> 컨테이너는 복잡한 환경을 딱딱 추상화, 정리하여 동일한 인터페이스를 제공한다. --> 프로그램 배포, 관리가 단순해진다.

'컨테이너'는 흔히 떠오르는 '화물선에 실리는 네모난 화물 수송용 박스'를 말하는 것은 아니지만, 서버 쪽에서 비슷한 역할을 한다. 바로 다양한 물건들을 **규격화**하여 **옮기기 쉽게(다루기 쉽게)**만들어주는 것이다! 다양한 프로그램, 실행환경을 컨테이너로 추상화하고 동일한 인터페이스를 제공하여 프로그램의 배포 및 관리를 단순하게 해준다. _(이름 정말 잘지은듯)_

컨테이너는 가상화 기술로 '격리된 공간'을 만들어서 프로세스가 그 공간에서 동작하게 하는 기술인데, 이는 **OS 가상화와는 다르다.** OS 가상화는 호스트 OS 위에 게스트 OS 전체를 가상화하여 하드웨어를 소프트웨어적으로 구현하고 사용하는 방식이다보니 성능저하 이슈가 있었고, 이를 개선하기 위해 반가상화 등 다양한 기술들이 나왔었지만 한계가 있었다. 완전히 독립된 공간과 시스템 자원을 할당받아 사용하는 방식은 '하이퍼바이저'를 반드시 거치기 때문에 일반 호스트에 비해 성능이 저하되는 것이다. 이에 반해 도커는 OS 전체를 가상화하는 것이 아니라 **프로세스 단위로 격리**하는 방식을 채택하여 CPU나 메모리를 딱 프로세스가 필요한만큼만 추가로 사용하여 성능적으로 거의 손실이 없도록 만들었다고 한다. **컨테이너는 격리된 환경에서 리눅스 커널 기능(namespaces, cgroups, netlink 등등)을 이용해서 생성되는 프로세스**이다.

_참고 1) 도커의 기본 네트워크 모드인 `Bridge` 모드는 약간의 성능손실이 있고, 네트워크 성능이 중요한 프로그램인 경우 `--net=howt`옵션을 고려해야한다고 한다._
_참고 2) 컨테이너라는 개념은 도커가 처음 만든건 아니다. LXC(Linux container), Jail, Solaris Zones, lmctfy(Let Me Contain That For You) 등등이 있었는데 도커만큼 대중화되진 못 한듯.. 반면 도커는 이미 있는 기술들을 조합해서 쉽고 간편하게 만들어서 제대로 대중화시킨 것 같다._

### 이미지

> 이미지는 **컨테이너 실행에 필요한 파일과 설정값 등을 포함하고 있는 것**이다. 

즉, 특정 프로세스를 실행하기 위한 환경으로서 계층화된 파일 시스템, 파일 집합이라고 할 수 있다. 이미지가 있으면 이미지가 말그대로 컨테이너를 실행하기 위한 **모든** 정보를 가지고 있기 때문에 더 이상 의존성 파일을 컴파일하고 이것저것 설치할 필요가 없다. 그냥 새로운 서버가 추가되면 미리 만들어둔 이미지를 다운 받고 그 이미지로 컨테이너를 생성하면 된다. 컨테이너는 얼마든지 추가로 생성, 실행할 수 있고, 값이 변하더라도 이미지에 영향을 주지 않는다. 이런 이유로 이미지는 상태값을 가지지 않고 변하지 않는(Immutable) 특성을 가지고 있다고할 수 있다. 


### Docker 설치

1. `curl`이 설치되어있다면, 아래 명령어를 입력한다. <br>
`curl fsSL https://get.docker.com/ | sudo sh`

*참고 1) curl은 command line용 data transfer tool이다. 자세한 것은 [이곳](http://magic.wickedmiso.com/137) 참고*
*참고 2) fsSL의 내용은 아래와 같다.[참고](https://explainshell.com/explain?cmd=curl+-fsSL+example.org)*
| flag | 설명                                                   |
| ---- | ---------------------------------------------------- |
| f    | - HTTP 요청 헤더의 contentType을 multipart/form-data로 보낸다. |
| s    | - 진행 과정이나 에러 정보를 보여주지 않는다.(-silent)                  |
| S    | - s flag와 함께 쓰이면 실패했을 때만 에러메세지를 출력하도록 한다.            |
| L    | - 서버에서 301, 302, 303 응답이 오면 redirection URL로 따라간다.   |


2. 정상설치되었을 경우 입력해보면 아래 명령어 입력시 '클라이언트'와 '서버'로 나누어서 정보가 출력된다. <br>
`Sudo docker version`

버전정보가 클라이언트와 서버로 나누어져 있는 이유는 도커가 클라이언트와 서버역할을 각각 할 수 있기 때문이다. 만약 도커 커맨드를 입력하게 되면 도커 클라이언트가 도커 서버로 명령을 전송하고, 결과를 받아서 클라이언트 터미널에 출력해준다. 기본값이 도커 서버의 소켓을 바라보고 있는 셈.

### Docker 실행

도커의 명령어는 다음과 같다.
`docker run [OPTIONS] IMAGE[:TAG|@DIGEST] [COMMAND] [ARG...]`

그리고 자주 사용되는 옵션은 아래와 같다.
| 옵션    | 설명                                                                             |
| ----- | ------------------------------------------------------------------------------ |
| -d    | detached mode 흔히 말하는 백그라운드 모드. 이 옵션을 안주면 보통 foreground로 실행되어 아무키도 입력할 수 없게 된다. |
| -p    | 호스트와 컨테이너의 포트를 연결(포워딩)                                                         |
| -v    | 호스트와 컨테이너의 디렉토리를 연결(마운트)                                                       |
| -e    | 컨테이너 내에서 사용할 환경변수를 설정                                                          |
| -name | 컨테이너 이름 설정                                                                     |
| -rm   | 프로세스 종료시 컨테이너 자동 제거                                                            |
| -t    | Allocate a pseudo-tty                                                          |
| -i    | Kep STDIN open even if not attached                                            |
| -it   | -i와 -t를 동시에 사용한 것으로 터미널 입력을 위한 옵션                                              |
| -link | 컨테이너 연결 [컨테이너명:별칭]                                                             |

#### Dockerfile

깨끗한 환경으로부터 애플리케이션 실행 환경까지의 최단경로 명령어들이다.


Tip 1)

컨테이너 실행했는데 DB나 서버 애플리케이션을 실행해서 입력은 할 수 없고 출력만 보게 되는 경우, Ctrl + P, Ctrl + Q를 차례대로 입력하여 컨테이너를 정지하지 않고 컨테이너에서 빠져나올 수 있다.




참고 1) http://magic.wickedmiso.com/229\
참고 2) https://docs.docker.com/engine/reference/run/
참고 3) https://subicura.com/2017/01/19/docker-guide-for-beginners-2.html
참고 4) http://pyrasis.com/docker.html