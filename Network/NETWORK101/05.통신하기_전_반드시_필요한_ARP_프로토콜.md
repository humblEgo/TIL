# 통신하기 전 반드시 필요한 ARP 프로토콜 - 이론

## ARP 프로토콜

> ARP 프로토콜은 3계층 프로토콜이지만 같은 대역에서 통신할 때만 사용한다.

####  ARP가 하는 일

- 같은 네트워크 대역에서 통신을 하기 위해서는 MAC주소가 필요하다. 이 MAC 주소를 IP주소를 이용해서 알아오는 프로토콜이 바로 `ARP 프로토콜`이다.
- 같은 네트워크 대역에서 통신을 한다고 하더라도 데이터를 보내기 위해서는 7계층부터 캡슐화를 통해 보내기 때문에 `IP주소와 MAC 주소`가 모두 필요하다.
  - 이 때 IP주소는 알고 MAC 주소는 모르더라도 `ARP 프로토콜을 통해 통신이 가능`하다.
- IP주소만 입력해도 자동으로 상대방의 MAC주소를 알아오게 된다.
- `ARP 프로토콜`은 보안상으로 매우 중요하다.

#### ARP 프로토콜의 구조 [영상](https://www.youtube.com/watch?v=LDsp-Xb168E&list=PL0d8NnikouEWcF1jJueLdjRIC4HsUlULi&index=7) 5분 참고

- 총 28바이트로 이루어진다.
- `Hardware type(2바이트)`: 2계층에서 사용되는 프로토콜이 뭔지 나타냄(보통은 이더넷 프로토콜이 온다). -> 일반적으로 `0001`
- `Protocol type(2바이트)`: 아래에서 나오는 `Protocol Address`의 타입이 뭔지 가르쳐줌. -> 일반적으로 IPv4인 `0800`
- `Hardware Address Length(2바이트)`: MAC주소의 길이 -> `06`이 들어온다.
- `Protocol Address Length`(2바이트): IPv4버전의 IP길이 -> `04`
- `Opcode`(2바이트): 오퍼레이션 코드. 2개 밖에 없다. 상대방에 MAC 주소를 요청하는지 아니면 요청에 대한 응답을 보내는 지에 대한 값 -> `000` + `x`
  - 물어볼 때는 x 가 1이고
  - 응답할 때는 2

위에서 살펴본 4개는 보통 `0001 | 0800 | 06 04 | 000x ` 로 입력된다.

- `Source Hardward Address(6바이트)` 에는 출발지의 MAC 주소가 들어간다.
- `Source Protocol Address(4바이트)`: IP주소
- `Destination Hardware Address(6바이트)`: 목적지의 MAC 주소
- `Destination Protocol Address(4바이트)`: 목적지의 IP주소 

## ARP 프로토콜의 통신 과정(영상 13분)

> IP주소만 알고 있을 때? 도대체 어떻게 MAC 주소를 알아올까?

#### IP주소로 MAC주소를 알아오는 과정

- 하나의 네트워크 대역(LAN)에서 ARP 프로토콜로 MAC 주소를 알아온다고 하자.
  - A가 C와 통신하고 싶음.
  - A가 C한테 ARP 프로토콜로 인캡슐레이션
    - 이 때 상대방의 MAC 주소를 입력해야 되는 곳에는 `00 00 00 00 00 00`을 넣자.
  - 2계층에서 `이더넷`프로토콜로 인캡슐레이션을 할 때 상대방의 MAC 주소를 `FF FF  FF FF FF FF`로 넣는다.
    - `FF FF FF FF FF FF`로  하는 통신은 `브로드 캐스팅`이다!
    - 따라서 같은 네트워크 대역에 있는 모든 컴퓨터에 통신을 보낸다!
    - 가운데 있는 2계층 장비 스위치가 2계층 프로토콜까지만 확인한다. 즉 여기서 `이더넷`프로토콜을 디캡슐레이션 하고 목적지한테 보낸다. 하지만 지금 목적지가 `브로드캐스팅`이니까 모든 컴퓨터에 통신을 보낸다. 이걸 받은 모두는  다시 2계층 헤더를 디캡슐레이션 해서 목적지가 자신이 맞는지 확인한다. `브로드캐스팅`이니까 내가 맞아. 따라서 `3계층` 헤더를 디캡슐레이션한다. 
    - 그런데 여기서 본인의 IP주소와 ARP 헤더에 적혀있는 IP주소가 다른 녀석이 있고 틀린 녀석이 있다. 만약 틀리면 패킷을 버린다!
    - 본인에게 온게 맞다면 `응답 ARP 프로토콜`을 만들어서 준다.
    - 응답으로 보낼 때 출발지의 MAC 주소를 자기 자신으로 해서 보내준다. 
    - 이제는 목적지를 알고 있으니깐 굳이 브로드캐스팅해서 전송하지 않고 자신에게 전송한 컴퓨터에게 직접적으로 데이터를 전송한다.
    - 데이터가 전송되면 가운데 있는 `스위치(2계층 장비)`가 `2계층 프로토콜(이더넷)`을 까보고 `A`가 보냈다는 걸 확인해서 `A`한테만 전송하게 된다.
    - 이제 `A`는 디캡슐레이션을 해서 `C`의 MAC 주소를 알게 된다.
    - 이제 `ARP 캐쉬 테이블`이라는 곳에다가 `C`의 `MAC` 주소를 적어놓는다.
    - 이제 통신이 시작된다.



## ARP 테이블

#### 나와 통신했던 컴퓨터들

- `cmd`에서 `arp -a`를 입력하자.

## 실습

#### ARP 테이블 확인해보기

- `cmd`에서 `arp -a`로 확인 가능
- 주기적으로 없어진다.

#### ARP 프로토콜 분석하기

- `Wireshark`에다가 `ARP`을 검색하자.
- `info`부분에 ? 가 있는게 있고 없는 게 있는데 
  - 있으면 `요청`
  - 없으면 `응답`
- 요청부분
  - `ARP(request) - 3계층`
    - ARP프로토콜 구조에서 살펴봤던 그대로 입력이 된다.(하드웨어타입, 프로토콜 타입, 사이즈, OPcode 등)
    - `Target MAC address`가 `00 00 00 00 00 00 00`으로 돼있는걸 알 수 있다.
  - `Ethernet - 2계층`
    - 목적지의 MAC 주소를 모르니깐 브로드 캐스팅했다.
    - 마지막에 padding 된 부분은 프레임의 최소크기를 맞추기 위해 붙여놓은거임
    - 최소 프레임의 크기는 60바이트인데 이더넷(14) + ARP(28) = 42바이트이므로 남은 18바이트 만큼을 0으로 패딩한다. (프레임의 최대 크기는 일반적으로 1514BYTE)
    - 가끔 패딩이 붙지 않는 부분도 있다. 이건 그냥 알지 말자. 귀찮다.
- 응답부분
  - 이제 그냥 읽을 수 있다. 이제 우리의 MAC 주소를 적어서 보내주는걸 확인할 수 있다. 그리고 브로드캐스팅이 아니라 유니캐스팅(1 vs 1)이다.