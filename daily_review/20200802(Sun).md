1. 학습 날짜 // 2020-08-02(일)

2. 학습시간 // 9:00~22:00

3. 학습 범위 및 주제 // 쓰레드 동기화

4. 동료 학습 방법 // 커뮤니티에 질문을 올려서 wpark님과 eunhkim님께 도움을 받았다.

5. 학습 목표 // mutex를 활용한 쓰레드 프로그래밍을 능숙하게 다루어본다.

---

6. 상세 학습 내용

# 쓰레드 교착상태(Deadlock)

교착상태는 상호 배제에 의해 나타나는 문제점으로, 둘 이상의 프로세스들이 자원을 점유한 상태에서 서로 다른 프로세스가 점유하고 있는 자원을 요구하며 무한정 기다리는 현상을 의미한다.

교착상태가 발생하기 위해서는 다음 네가지 조건이 충족되어야한다. 만약 이 네가지 조건 중 하나라도 충족되지 않으면 교착상태가 발생하지 않는다.

- 상호배제(Mutual Exclusion) : 한번에 한개의 프로세스만이 공유 자원을 사용할 수 있어야한다.
- 점유와 대기(Hold and Wait) : 최소한 하나의 자원을 점유하고 있으면서 다른 프로세스에 할다오디어 사용되고 있는 자원을 추가로 점유하기 위해 대기하는 프로세스가 있어야한다.
- 비선점(Non-preemption) : 다른 프로세스에 할당된 자원은 사용이 끝날 때까지 뺴앗을 수 없어야한다.
- 환형 대기(circular Wait) : 공유자원과 공유자원을 사용하기 위해 대기하는 프로세스들이 원형으로 구성되어 있어 자신에게 할당된 자원을 점유하면서 앞이나 뒤에 있는 프로세스의 자원을 요구해야한다.

교착 상태 처리방법은 다음과 같은 세 가지 다른 방법이 있다.
1) 시스템이 결코 교착상태가 되지 않도록 보장하기 위하여 교착상태를 예방하는 프로토콜을 사용
2) 시스템이 교착 상태가 되도록 허용한 다음에 회복시키는 방법
3) 문제를 무시하고 교착 상태가 시스템에서 결코 발생하지 않는 척한다.

현재 대부분의 운영체제들은 교착 상태를 막는 것이 불가능하다. 교착 상태가 발생하면 여러 운영체제들은 제각기 다른 비표준 방식들로 이러한 교착 상태에 대응한다. 주로 세 번째 해결안이 UNIX와 Window를 포함해 대부분의 운영체제가 사용하는 방법이라고 한다. 교착상태가 발생했을 때 시스템은 작동을 정지하고 수작업으로 다시 시작할 필요가 있지만, 교착상태 예방, 회피, 탐지와 복구 방법들보다 비용이 적기 때문이다.

## 교착상태의 예방(Prevention)

교착상태 예방 기법은 교착상태가 발생하지 않도록 사전에 시스템을 제어하는 방법으로 교착상태 발생의 네가지 조건 중에서 어느 하나를 제거함으로써 수행된다. 문제는 자원 사용의 효율성이 떨어지고 비용이 많이 드는 문제점이 있다고 한다.
- 상호배제 부정
    - 방법: 한번에 여러개의 프로세스가 공유 자원을 사용할 수 있도록 한다.
    - 단점: 어떤 자원들은 근본적으로 공유가 불가능하기 떄문에 일반적으로 상호배제 조건을 거부할 수 없다.
- 점유 및 대기 부정
    - 방법: 프로세스가 실행되기 전 필요한 모든 자원을 할당하여 프로세스 대기를 없애거나 자원이 점유되지 않은 상태에서만 자원을 요구하도록 한다.
    - 단점: 1) 많은 자원들이 할당된 후 오랫동안 사용되지 않기 때문에 자원의 이용도가 낮을 수 있다. 2) 기아 상태가 가능하다. 자주쓰이는 자원들을 여러개 필요로 하는 프로세스는 자신이 필요한 자원 중에서 최소한 하나가 항상 다른 프로세스에 할당되어있을 확률이 높기 때문에 무한정 대기해야할 수도 있다.
- 비선점 부정
    - 방법: 자원을 점유하고 있는 프로세스가 다른 자원을 요구할 때는 일단 점유하고 있는 자원을 모두 반납하고, 요구한 자원을 사용하기 위해 기다리게 한다.
    - 단점: 프로세스는 자신이 요청하고 있는 새로운 자원은 물론 이미 점유하였던 옛 자원들을 다시 획득할 수 있을 때에만 프로세스가 시작될 것이다.
- 환형대기 부정
    - 방법: 자원을 **선형 순서로 분류**하고 고유 번호를 할당하고, 각 프로세스는 현재 점유한 자원의 고유 번호보다 앞이나 뒤 어느 한쪽 방향으로만 자원을 요구하도록 한다.

## 교착상태의 회피 기법(Avoidance)

교착상태 회피 기법은 교착상태가 발생할 가능성을 배제하지 않고, 교착상태가 발생하면 적절히 피해나가는 방법이다. 
회피 기법은 시스템의 상태가 항상 '안전상태'를 떠나지 않도록 고수하는 것으로, 프로세스가 자원을 요구할 때 시스템은 **자원을 할당한 후에도 안정상태로 남아있게 되는지를 사전에 검사**하여 교착상태의 발생을 회피한다.

크게 아래 두가지가 있는데, 주로 은행원 알고리즘을 쓴다고 한다.
- 자원할당 그래프 알고리즘(Resource Allocation Graph Algorithm)
    - 특징: 자원이 1개일 때 쓸 수 있다.

- 은행원 알고리즘(Banker's Algorithm)
    - 특징: 자원 할당 알고리즘보다 효율성이 떨어진다. 하지만 자원이 여러개일 때 적용할 수 있다. 모든 작업이 작업 요청 전에 최대 요구량을 명시하는 것은 대화식 시스템에서는 불가능. 시스템 각각의 자원의 수는 동일해야만 장애 발생 시에 불안정한 상태로 전이되는 것을 막을 수 있음. 복잡한 작업은 무한 대기로 빠질 수 있고 실행 중인 작업의 수가 고정되어야 함.

> 안정상태(Safe state)란? 시스템이 특정한 순서대로 각 프로세스에 자원을 할당할 수 있고, 모든 작업이 완료될 수 있는 상태!


### 참고
https://m.blog.naver.com/PostView.nhn?blogId=doublebee1&logNo=220350605738&proxyReferer=https:%2F%2Fwww.google.com%2F
https://coding-factory.tistory.com/311
https://m.blog.naver.com/PostView.nhn?blogId=scw0531&logNo=221420360531&proxyReferer=https:%2F%2Fwww.google.com%2F

---

7. 학습 내용에 대한 개인적인 총평

쓰레드 교착상태에 대해서 학습하면 할 수록 재밌는 수학문제를 푸는 것 같아서 즐겁습니다ㅎㅎ 확실히 저는 이런 쪽으로 흥미를 느끼는듯합니다.
ft_service를 다룰 때의 힘듦과 비교하면 천국 같네요. 다만 이걸 어떻게 구현할지는 고민스럽긴 합니다. 한껏 즐기고 빠르게 진도 빼보아야겠습니다.

---

다음 학습 계획

- philosopher one 구현