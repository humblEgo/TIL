1. 학습 날짜 // 2020-08-12(수)

2. 학습시간 // 9:00~22:00

3. 학습 범위 및 주제 // 세마포어

4. 동료 학습 방법 // eunhkim님과 코드 개선방법을 토의함

5. 학습 목표 // philo_three 구현완료

---

6. 상세 학습 내용

#### 문제) philo_three 철학자를 199명 만들면, 죽는 시점으로 부터 **10밀리세컨드이내로 죽었다는 메세지 출력하는 것**을 보장되지 않는 경우가 발생한다!
#### 해결) 터미널에 출력하는 과정에서 병목이 발생한다는 것을 알게되었다. log.txt 등의 파일에 출력을 보내어서 병목을 없애며 시연하기로 결정하였다.

후.. 이 부분에서 정말 많은 시간을 썼다. 일단 코드 사이에 있는 usleep으로 인한 병목으로 인해 철학자들이 식사를 시작하는 시간에서 차이가 나는 것이 가장 큰 원인이었다. 이는 수정하여 금방 해결하였다. 문제는 stdout으로 출력을 보낼 때는 10번 중에 2번은 철학자의 죽음으로부터 10밀리세컨드내로 철학자가 죽었다는 메세지가 출력되지 않는 현상이 나타나는 것이었다. 더 신기한 것은 log로 분석하기 위해 log.txt 파일을 만들어 출력을 보내었을 때는 30번 테스트하는 동안 에러가 전혀 발생하지 않았다. 깊게 파고들어보니 stdout 출력이 원래 다른 fd에 값을 넘기는 것보다 느리고, 이는 터미널 성능상의 문제 때문이라는 것을 알 수 있었다. [참고:갓택오버플로우](https://stackoverflow.com/questions/3857052/why-is-printing-to-stdout-so-slow-can-it-be-sped-up)
하지만, 정말 stdout으로 시간내에 출력시키는게 불가능한가? 그렇다면 philo_one, philo_two는 왜 시간내에 잘 출력되는가? 하는 의문을 해소할 수 없었다. 동료 eunhkim님과의 토의를 통해 어느정도 의문을 해소할 수 있었다. 지금은 철학자 루틴 중 `eating` 함수 실행시에 `last_eat_time`을 업데이트할 때 쓰이는 세마포어와 `monitoring` 함수에서 `last_eat_time` 값을 검사하기 위한 세마포어를 엮어놓았었다. 문제는 모니터링 함수에서 `last_eat_time`을 검사하기 위해 세마포어에서 접근하는 시간이 `usleep(10)`으로 10 마이크로초로 설정되어있었다보니 세마포어에 너무 빈번하게 접근하고, 결과적으로 `eating` 함수와 세마포어를 너무 빈번하게 wait, post하며 병목이 발생하는 것으로 추정하였다. VNC에서 동영상을 틀어놓고 프로그램을 실행시키면 쓰레드 모니터링 속도가 늦어지는 것을 보니, context switch에 부하가 걸리는 것도 원인일 수 있지 않을까 싶다.. 음 일단 적어도 `199 310 200 100` 케이스는 잘 통과하는 걸로..


#### 문제) valgrind로 memroy leak을 측정했을 때, 세마포어를 쓰는 philo_two와 philo_three에서 '메모리누수 가능성' 부분이 체크되는 것을 확인하였다.
#### 해결) 해결이라긴 뭐하지만.. macOS에서 leaks로 체크했을 때는 이부분을 memory leak으로 보지 않는 것을 확인하여 그대로 제출하였다.

malloc한 부분은 모두 free했던 것 같은데 이상하다... 싶었는데 실험해보니 생성한 쓰레드가 detach되어 종료와 함께 자원을 반환하기 전에 메인쓰레드가 종료되어버리는 것이 원인이었다. 이 부분이 치명적인 memory leak이라면 꼭 잡아야겠지만.. 'leaks'로는 안 잡히는 부분이고 '메모리누수 가능성' 항목이며, 이 부분을 잡기 위해 시간을 쓰는 것이 시간대비 학습량이 적을 것으로 판단되어 무시하기로 결정했다.

---    
    
7. 학습 내용에 대한 개인적인 총평 

철학자 프로그램을 제대로 테스트하기 위해서 가장 프로그램에 빡센 조건을 많이 입력해보았는데, 철학자가 199명일 때 '10초내로 죽음 메세지를 출력'하는 조건을 클리어하는 것이 많이 힘들었습니다. 사실 동료들이 이 부분을 제대로 채점하지 않는 것을 알고 있지만 저 스스로의 기준 때문에 그대로 제출하질 못했네요. 결과적으로 'TIME_TO_DIE'가 310밀리초일 때는 199명의 철학자가 생성되더라도 제대로 작동하게끔 개선하고 제출했습니다.
'TIME_TO_DIE'가 100밀리초일 때는 또 10밀리초내로 죽음메세지가 표시되지 않는 것을 확인하였지만, 이 부분까지 개선하는 것은 '과잉개발'인 것 같아서 무시하기로 결정했습니다.
어느 수준까지 구현할지 결정하는 것도 개발자의 능력이라던데 제 경우 성향상 자꾸 완벽주의가 고개를 쳐들어서 '과잉개발'하기 쉬운 것 같습니다. 이 부분도 훈련해야겠습니다.

---

다음 학습 계획

- CPP module00 시작